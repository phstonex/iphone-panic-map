<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ç»´ä¿®æ ‡å‡†åœ¨çº¿ç®¡ç†ç³»ç»Ÿ</title>
<style>
* {box-sizing: border-box;}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,'PingFang SC','Microsoft YaHei',sans-serif;
margin:0;padding:0;background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);min-height:100vh;}

/* ç™»å½•ç•Œé¢ */
.login-wrapper{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px;}
.login-container{background:#fff;padding:40px;border-radius:16px;box-shadow:0 8px 32px rgba(0,0,0,0.3);
max-width:450px;width:100%;display:block;}
.login-container.hidden{display:none;}
.login-title{font-size:26px;font-weight:bold;color:#333;margin-bottom:10px;text-align:center;}
.login-subtitle{color:#666;font-size:14px;margin-bottom:30px;text-align:center;}
.login-input{width:100%;padding:12px 16px;border:2px solid #e0e0e0;border-radius:8px;font-size:14px;
margin-bottom:15px;transition:all 0.3s;}
.login-input:focus{outline:none;border-color:#667eea;}
.login-btn{width:100%;padding:14px;background:#667eea;color:#fff;border:none;border-radius:8px;
font-size:16px;font-weight:600;cursor:pointer;transition:all 0.3s;margin-top:10px;}
.login-btn:hover{background:#5568d3;transform:translateY(-2px);box-shadow:0 4px 12px rgba(102,126,234,0.4);}
.error-msg{background:#fee;color:#c00;padding:10px;border-radius:6px;font-size:13px;margin-bottom:15px;display:none;}
.info-box{background:#e7f3ff;color:#004085;padding:12px;border-radius:6px;font-size:12px;margin-top:15px;
line-height:1.6;}
.info-box code{background:#fff;padding:2px 6px;border-radius:3px;font-family:monospace;}
.login-footer{margin-top:20px;text-align:center;font-size:12px;color:#999;}

/* ä¸»ç¼–è¾‘ç•Œé¢ */
.main-container{display:none;padding:20px;max-width:1200px;margin:0 auto;}
.main-container.active{display:block;}
.header{background:#fff;padding:20px 30px;border-radius:12px;margin-bottom:20px;
box-shadow:0 4px 16px rgba(0,0,0,0.1);}
.header-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;}
.header-left{display:flex;align-items:center;gap:15px;}
.logo{font-size:24px;font-weight:bold;color:#667eea;}
.logout-btn{padding:8px 16px;background:#dc3545;color:#fff;border:none;border-radius:6px;
cursor:pointer;font-size:13px;}
.logout-btn:hover{background:#c82333;}
.github-status{display:flex;gap:10px;align-items:center;padding:12px;background:#f8f9fa;border-radius:8px;
font-size:13px;flex-wrap:wrap;}
.status-indicator{width:8px;height:8px;border-radius:50%;background:#28a745;flex-shrink:0;}
.status-indicator.disconnected{background:#dc3545;}
.github-info{flex:1;color:#666;min-width:200px;}
.btn-config{padding:6px 12px;background:#6c757d;color:#fff;border:none;border-radius:6px;
cursor:pointer;font-size:12px;white-space:nowrap;}
.btn-config:hover{background:#5a6268;}
.auto-save{font-size:12px;color:#28a745;padding:6px 12px;background:#d4edda;border-radius:6px;display:none;}

.content{background:#fff;padding:35px;border-radius:16px;box-shadow:0 8px 32px rgba(0,0,0,0.15);}
h1{color:#333;margin:0 0 8px 0;font-size:28px;}
.subtitle{color:#666;font-size:14px;margin-bottom:25px;}

.version-tabs{display:flex;gap:10px;margin-bottom:25px;flex-wrap:wrap;border-bottom:2px solid #e0e0e0;padding-bottom:10px;}
.tab{padding:10px 20px;background:#f5f5f5;border:none;border-radius:8px 8px 0 0;cursor:pointer;font-size:14px;
font-weight:500;transition:all 0.3s;color:#555;}
.tab:hover{background:#e8e8e8;}
.tab.active{background:#667eea;color:#fff;transform:translateY(-2px);}
.tab-new{background:#28a745;color:#fff;}
.tab-new:hover{background:#218838;}

.version-content{display:none;}
.version-content.active{display:block;animation:fadeIn 0.3s;}
@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}

.version-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding:15px;
background:#f8f9fa;border-radius:8px;flex-wrap:wrap;gap:10px;}
.version-title{font-size:16px;font-weight:bold;color:#667eea;flex:1;padding:8px;border:1px solid #ddd;
border-radius:6px;min-width:200px;}
.btn-delete{background:#dc3545;color:#fff;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;font-size:13px;}
.btn-delete:hover{background:#c82333;}

.section{background:#fafafa;border:2px solid #e0e0e0;border-radius:8px;padding:18px;margin-bottom:18px;}
.section-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;gap:10px;flex-wrap:wrap;}
.section-title-input{flex:1;padding:8px;border:1px solid #ddd;border-radius:6px;font-size:14px;
font-weight:bold;min-width:200px;}
.btn-remove-section{background:#dc3545;color:#fff;border:none;padding:4px 10px;border-radius:4px;
cursor:pointer;font-size:12px;white-space:nowrap;}
textarea{width:100%;min-height:90px;padding:12px;border:1px solid #ddd;border-radius:6px;
font-family:inherit;font-size:14px;line-height:1.6;resize:vertical;}

.btn-add-section{width:100%;padding:12px;background:#6c757d;color:#fff;border:none;border-radius:8px;
cursor:pointer;font-size:14px;margin-bottom:20px;display:flex;align-items:center;justify-content:center;gap:8px;}
.btn-add-section:hover{background:#5a6268;}

.btn-group{display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:10px;margin-bottom:15px;}
button{padding:12px 24px;border:none;border-radius:8px;cursor:pointer;font-size:14px;font-weight:500;
transition:all 0.2s;}
.btn-preview{background:#007bff;color:#fff;}
.btn-preview:hover{background:#0056b3;}
.btn-download{background:#17a2b8;color:#fff;}
.btn-download:hover{background:#138496;}
.btn-save{background:#ffc107;color:#333;font-weight:600;}
.btn-save:hover{background:#e0a800;}
.btn-publish{background:#28a745;color:#fff;font-weight:600;}
.btn-publish:hover{background:#218838;}

.success{background:#d4edda;color:#155724;padding:12px;border-radius:6px;margin-top:15px;display:none;}
.warning{background:#fff3cd;color:#856404;padding:12px;border-radius:6px;margin-top:15px;display:none;}
#output{display:none;margin-top:20px;padding:20px;background:#f8f9fa;border:2px solid #dee2e6;border-radius:8px;}
pre{white-space:pre-wrap;word-wrap:break-word;font-size:12px;background:#fff;padding:15px;
border-radius:6px;overflow-x:auto;max-height:400px;}

.modal{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.6);
align-items:center;justify-content:center;z-index:1000;padding:20px;}
.modal.show{display:flex;}
.modal-content{background:#fff;padding:30px;border-radius:12px;max-width:500px;width:100%;max-height:90vh;overflow-y:auto;}
.modal-title{font-size:20px;font-weight:bold;margin-bottom:15px;}
.modal-input{width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:14px;margin-bottom:15px;}
.modal-label{font-size:13px;font-weight:500;color:#555;margin-bottom:5px;display:block;}
.modal-buttons{display:flex;gap:10px;}
.modal-buttons button{flex:1;}
.modal-help{font-size:12px;color:#666;line-height:1.6;margin-top:10px;padding:10px;background:#f8f9fa;
border-radius:6px;}
.modal-help a{color:#0056b3;}

@media (max-width: 768px) {
  .header-top{flex-direction:column;gap:10px;align-items:stretch;}
  .github-status{flex-direction:column;align-items:flex-start;}
  .btn-group{grid-template-columns:1fr;}
  .login-container{padding:30px 20px;}
  .content{padding:20px;}
}
</style>
</head>
<body>

<!-- ç™»å½•ç•Œé¢ -->
<div class="login-wrapper">
  <div class="login-container" id="loginContainer">
    <div class="login-title">ğŸ” ç»´ä¿®æ ‡å‡†ç®¡ç†ç³»ç»Ÿ</div>
    <div class="login-subtitle">è¯·è¾“å…¥æˆæƒç ç™»å½•</div>
    <div class="error-msg" id="errorMsg">æˆæƒç é”™è¯¯ï¼Œè¯·é‡è¯•</div>
    <input type="password" class="login-input" id="authCode" placeholder="è¯·è¾“å…¥æˆæƒç "
           onkeypress="if(event.key==='Enter') login()">
    <button class="login-btn" onclick="login()">ç™»å½•</button>
    <div class="info-box">
      <strong>ğŸ“Œ é»˜è®¤æˆæƒç ï¼š</strong> <code>admin123</code><br>
      <strong>ğŸš€ GitHub é…ç½®ï¼š</strong> ç™»å½•ååœ¨å³ä¸Šè§’é…ç½® GitHub Token å³å¯å‘å¸ƒåˆ°ä»“åº“
    </div>
    <div class="login-footer">
      ç»´ä¿®æ ‡å‡†åœ¨çº¿ç®¡ç†ç³»ç»Ÿ v2.0
    </div>
  </div>
</div>

<!-- ä¸»ç¼–è¾‘ç•Œé¢ -->
<div class="main-container" id="mainContainer">
  <div class="header">
    <div class="header-top">
      <div class="header-left">
        <div class="logo">ğŸ› ï¸ ç»´ä¿®æ ‡å‡†ç®¡ç†</div>
        <div class="auto-save" id="autoSave">âœ“ å·²ä¿å­˜</div>
      </div>
      <button class="logout-btn" onclick="logout()">é€€å‡ºç™»å½•</button>
    </div>
    <div class="github-status">
      <span class="status-indicator" id="githubIndicator"></span>
      <span class="github-info" id="githubInfo">GitHub æœªé…ç½®</span>
      <button class="btn-config" onclick="showGitHubConfig()">âš™ï¸ é…ç½®</button>
    </div>
  </div>

  <div class="content">
    <h1>ç»´ä¿®æ ‡å‡†ç‰ˆæœ¬ç®¡ç†</h1>
    <div class="subtitle">åœ¨çº¿ç¼–è¾‘å¹¶å‘å¸ƒåˆ° GitHub Pages</div>

    <div class="version-tabs" id="versionTabs"></div>
    <div id="versionsContainer"></div>

    <div class="btn-group">
      <button class="btn-save" onclick="saveData()">ğŸ’¾ æœ¬åœ°ä¿å­˜</button>
      <button class="btn-publish" onclick="publishToGitHub()">ğŸš€ å‘å¸ƒåˆ° GitHub</button>
      <button class="btn-preview" onclick="generateHTML()">ğŸ” é¢„è§ˆ</button>
      <button class="btn-download" onclick="downloadHTML()">ğŸ“¥ ä¸‹è½½</button>
    </div>

    <div class="success" id="success"></div>
    <div class="warning" id="warning"></div>
    <div id="output">
      <h3>ç”Ÿæˆçš„ HTML ä»£ç ï¼š</h3>
      <pre id="htmlCode"></pre>
    </div>
  </div>
</div>

<!-- æ–°å»ºç‰ˆæœ¬å¼¹çª— -->
<div class="modal" id="newVersionModal">
  <div class="modal-content">
    <div class="modal-title">æ–°å»ºç‰ˆæœ¬</div>
    <input type="text" class="modal-input" id="newVersionInput" placeholder="è¾“å…¥ç‰ˆæœ¬å·ï¼Œå¦‚ï¼šV22"
           onkeypress="if(event.key==='Enter') createVersion()">
    <div class="modal-buttons">
      <button class="btn-publish" onclick="createVersion()">åˆ›å»º</button>
      <button class="btn-delete" onclick="closeModal('newVersionModal')">å–æ¶ˆ</button>
    </div>
  </div>
</div>

<!-- GitHub é…ç½®å¼¹çª— -->
<div class="modal" id="githubConfigModal">
  <div class="modal-content">
    <div class="modal-title">GitHub é…ç½®</div>

    <label class="modal-label">GitHub Token</label>
    <input type="password" class="modal-input" id="githubToken" placeholder="ghp_xxxxxxxxxxxx">

    <label class="modal-label">ä»“åº“æ‰€æœ‰è€…ï¼ˆç”¨æˆ·åï¼‰</label>
    <input type="text" class="modal-input" id="githubOwner" placeholder="ä¾‹å¦‚: hydrax">

    <label class="modal-label">ä»“åº“åç§°</label>
    <input type="text" class="modal-input" id="githubRepo" placeholder="ä¾‹å¦‚: iphone-panic-map">

    <label class="modal-label">åˆ†æ”¯ï¼ˆé»˜è®¤ mainï¼‰</label>
    <input type="text" class="modal-input" id="githubBranch" placeholder="main" value="main">

    <div class="modal-help">
      <strong>å¦‚ä½•è·å– GitHub Tokenï¼š</strong><br>
      1. è®¿é—® <a href="https://github.com/settings/tokens" target="_blank">GitHub Settings â†’ Tokens</a><br>
      2. ç‚¹å‡» "Generate new token (classic)"<br>
      3. å‹¾é€‰ <code>repo</code> æƒé™<br>
      4. ç”Ÿæˆå¹¶å¤åˆ¶ Token
    </div>

    <div class="modal-buttons">
      <button class="btn-publish" onclick="saveGitHubConfig()">ä¿å­˜</button>
      <button class="btn-delete" onclick="closeModal('githubConfigModal')">å–æ¶ˆ</button>
    </div>
  </div>
</div>

<script>
// é…ç½®
const AUTH_CODES = ['admin123', 'repair2024', 'manager888'];
const AUTH_KEY = 'repairAuthToken';
const DATA_KEY = 'repairVersionsData';
const GITHUB_CONFIG_KEY = 'githubConfig';

// é»˜è®¤æ•°æ®
const defaultVersions = {
  v18: {
    title: 'V18 ç»´ä¿®æ ‡å‡†ï¼ˆå†…éƒ¨é€šç”¨ï¼‰',
    sections: [
      {title: 'â‘  ç”µæ± æ ‡å‡†', content: 'â€¢ å¥åº·åº¦ ä½äº 85% â†’ ä¸€å¾‹æ›´æ¢ï¼›æ›´æ¢åç›®æ ‡ â‰¥ 95%\nâ€¢ å®é™…å®¹é‡æˆ–å†…é˜»è¡°é€€æ˜æ˜¾ï¼Œå¥åº·åº¦ ä½äº 70% â†’ å»ºè®®æ›´æ¢ç”µèŠ¯çº§åˆ«å¤„ç†'},
      {title: 'â‘¡ åæ‘„æ£€æµ‹æµç¨‹', content: 'â€¢ ä¼˜å…ˆç¡®è®¤æ˜¯å¦å¯æ¸…æ´æˆ–ä¿®å¤ï¼ˆé•œç»„ã€ æ¨¡ç»„åº§ï¼‰\nâ€¢ åŒºåˆ†ï¼šå•æ‘„æŸå / æ•´ç»„æŸå\nâ€¢ èƒ½æ¸…æ´å°±æ¸…æ´ï¼Œèƒ½ä¿®å¤å°±ä¿®å¤ï¼›ç¡®å±æŸåå†æ›´æ¢æ•´ä¸ªæ¨¡ç»„'},
      {title: 'â‘¢ å±å¹•æ›´æ¢æœºå‹è¦æ±‚', content: 'â€¢ iPhone 13 Pro / 13 Pro Max â†’ å¿…é¡»ä½¿ç”¨ OLED å±\nâ€¢ ç¿»æ–°æœºå‹ â†’ å¯æ›´æ¢ LCD + IC æ–¹æ¡ˆ'},
      {title: 'â‘£ åŠŸèƒ½å®Œæ•´æ€§æ ‡å‡†', content: 'â€¢ å¦‚é‡éš¾ä»¥ä¿®å¤çš„åŠŸèƒ½ï¼šFace ID / RT / ä¼ æ„Ÿç­‰ â†’ å¿…é¡»å¤‡æ³¨è®°å½•\nâ€¢ æœªå¤‡æ³¨çš„è®¾å¤‡é»˜è®¤ å…¨åŠŸèƒ½æ­£å¸¸\nâ€¢ é‡ç‚¹ï¼šæœ€ç»ˆäº¤ä»˜å¿…é¡»"å…¨åŠŸèƒ½ä¿®å¥½"'}
    ]
  }
};

let versions = {};
let currentVersion = 'v18';
let autoSaveTimer;
let githubConfig = null;

// ========== ç™»å½•åŠŸèƒ½ ==========
function login() {
  const code = document.getElementById('authCode').value.trim();
  const errorMsg = document.getElementById('errorMsg');

  if (AUTH_CODES.includes(code)) {
    const token = btoa(Date.now() + ':' + code);
    localStorage.setItem(AUTH_KEY, token);

    document.getElementById('loginContainer').parentElement.style.display = 'none';
    document.getElementById('mainContainer').classList.add('active');

    loadData();
    loadGitHubConfig();
    initEditor();
  } else {
    errorMsg.style.display = 'block';
    document.getElementById('authCode').value = '';
    setTimeout(() => errorMsg.style.display = 'none', 3000);
  }
}

function logout() {
  if (confirm('ç¡®å®šè¦é€€å‡ºå—ï¼Ÿè¯·ç¡®ä¿å·²ä¿å­˜æ•°æ®ã€‚')) {
    localStorage.removeItem(AUTH_KEY);
    location.reload();
  }
}

function checkAuth() {
  const token = localStorage.getItem(AUTH_KEY);
  if (token) {
    try {
      const decoded = atob(token);
      const timestamp = parseInt(decoded.split(':')[0]);
      const now = Date.now();

      if (now - timestamp < 30 * 24 * 60 * 60 * 1000) { // 30å¤©æœ‰æ•ˆ
        document.getElementById('loginContainer').parentElement.style.display = 'none';
        document.getElementById('mainContainer').classList.add('active');
        loadData();
        loadGitHubConfig();
        initEditor();
        return;
      }
    } catch(e) {}
  }
}

// ========== æ•°æ®ç®¡ç† ==========
function loadData() {
  const saved = localStorage.getItem(DATA_KEY);
  if (saved) {
    try {
      versions = JSON.parse(saved);
    } catch(e) {
      versions = JSON.parse(JSON.stringify(defaultVersions));
    }
  } else {
    versions = JSON.parse(JSON.stringify(defaultVersions));
  }
}

function saveData() {
  localStorage.setItem(DATA_KEY, JSON.stringify(versions));
  showSuccess('æ•°æ®å·²ä¿å­˜åˆ°æœ¬åœ°æµè§ˆå™¨ï¼');
  showAutoSave();
}

function enableAutoSave() {
  clearTimeout(autoSaveTimer);
  autoSaveTimer = setTimeout(() => {
    localStorage.setItem(DATA_KEY, JSON.stringify(versions));
    showAutoSave();
  }, 2000);
}

function showAutoSave() {
  const el = document.getElementById('autoSave');
  el.style.display = 'block';
  setTimeout(() => el.style.display = 'none', 2000);
}

// ========== GitHub é…ç½® ==========
function loadGitHubConfig() {
  const saved = localStorage.getItem(GITHUB_CONFIG_KEY);
  if (saved) {
    try {
      githubConfig = JSON.parse(saved);
      updateGitHubStatus(true);
    } catch(e) {
      updateGitHubStatus(false);
    }
  } else {
    updateGitHubStatus(false);
  }
}

function showGitHubConfig() {
  if (githubConfig) {
    document.getElementById('githubToken').value = githubConfig.token;
    document.getElementById('githubOwner').value = githubConfig.owner;
    document.getElementById('githubRepo').value = githubConfig.repo;
    document.getElementById('githubBranch').value = githubConfig.branch || 'main';
  }
  document.getElementById('githubConfigModal').classList.add('show');
}

function saveGitHubConfig() {
  const token = document.getElementById('githubToken').value.trim();
  const owner = document.getElementById('githubOwner').value.trim();
  const repo = document.getElementById('githubRepo').value.trim();
  const branch = document.getElementById('githubBranch').value.trim() || 'main';

  if (!token || !owner || !repo) {
    alert('è¯·å¡«å†™å®Œæ•´çš„é…ç½®ä¿¡æ¯ï¼');
    return;
  }

  githubConfig = { token, owner, repo, branch };
  localStorage.setItem(GITHUB_CONFIG_KEY, JSON.stringify(githubConfig));
  updateGitHubStatus(true);
  closeModal('githubConfigModal');
  showSuccess('GitHub é…ç½®å·²ä¿å­˜ï¼');
}

function updateGitHubStatus(connected) {
  const indicator = document.getElementById('githubIndicator');
  const info = document.getElementById('githubInfo');

  if (connected && githubConfig) {
    indicator.classList.remove('disconnected');
    info.textContent = `å·²è¿æ¥: ${githubConfig.owner}/${githubConfig.repo}`;
  } else {
    indicator.classList.add('disconnected');
    info.textContent = 'GitHub æœªé…ç½® - ç‚¹å‡»"é…ç½®"æŒ‰é’®è®¾ç½®';
  }
}

// ========== GitHub å‘å¸ƒ ==========
async function publishToGitHub() {
  if (!githubConfig) {
    showWarning('è¯·å…ˆé…ç½® GitHub è¿æ¥ï¼ç‚¹å‡»å³ä¸Šè§’"é…ç½®"æŒ‰é’®ã€‚');
    return;
  }

  const filename = `${currentVersion.toLowerCase()}.html`;
  const content = generateHTMLContent();

  try {
    showWarning('æ­£åœ¨å‘å¸ƒåˆ° GitHub...');

    // è·å–æ–‡ä»¶ SHAï¼ˆå¦‚æœæ–‡ä»¶å·²å­˜åœ¨ï¼‰
    const getUrl = `https://api.github.com/repos/${githubConfig.owner}/${githubConfig.repo}/contents/${filename}?ref=${githubConfig.branch}`;
    let sha = null;

    try {
      const getResponse = await fetch(getUrl, {
        headers: {
          'Authorization': `token ${githubConfig.token}`,
          'Accept': 'application/vnd.github.v3+json'
        }
      });

      if (getResponse.ok) {
        const data = await getResponse.json();
        sha = data.sha;
      }
    } catch(e) {
      // æ–‡ä»¶ä¸å­˜åœ¨ï¼Œç»§ç»­åˆ›å»º
    }

    // åˆ›å»ºæˆ–æ›´æ–°æ–‡ä»¶
    const putUrl = `https://api.github.com/repos/${githubConfig.owner}/${githubConfig.repo}/contents/${filename}`;
    const message = sha ? `æ›´æ–° ${currentVersion.toUpperCase()} ç»´ä¿®æ ‡å‡†` : `åˆ›å»º ${currentVersion.toUpperCase()} ç»´ä¿®æ ‡å‡†`;

    const putData = {
      message: message,
      content: btoa(unescape(encodeURIComponent(content))), // æ­£ç¡®ç¼–ç ä¸­æ–‡
      branch: githubConfig.branch
    };

    if (sha) {
      putData.sha = sha;
    }

    const putResponse = await fetch(putUrl, {
      method: 'PUT',
      headers: {
        'Authorization': `token ${githubConfig.token}`,
        'Accept': 'application/vnd.github.v3+json',
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(putData)
    });

    if (putResponse.ok) {
      const result = await putResponse.json();
      const pageUrl = `https://${githubConfig.owner}.github.io/${githubConfig.repo}/${filename}`;
      showSuccess(`âœ… å‘å¸ƒæˆåŠŸï¼<br>ğŸ“„ æ–‡ä»¶: <code>${filename}</code><br>ğŸŒ è®¿é—®: <a href="${pageUrl}" target="_blank" style="color:#155724;font-weight:bold;">${pageUrl}</a>`);
    } else {
      const error = await putResponse.json();
      throw new Error(error.message || 'å‘å¸ƒå¤±è´¥');
    }

  } catch (error) {
    showWarning('å‘å¸ƒå¤±è´¥: ' + error.message + '<br>è¯·æ£€æŸ¥ Token æƒé™å’Œç½‘ç»œè¿æ¥ã€‚');
    console.error('GitHub API Error:', error);
  }
}

// ========== ç¼–è¾‘å™¨åŠŸèƒ½ ==========
function initEditor() {
  if (Object.keys(versions).length === 0) {
    versions = JSON.parse(JSON.stringify(defaultVersions));
  }
  currentVersion = Object.keys(versions)[0];
  renderTabs();
  renderVersionContent();
}

function renderTabs() {
  const tabs = Object.keys(versions).map(v =>
    `<button class="tab ${v === currentVersion ? 'active' : ''}" onclick="switchVersion('${v}')">${v.toUpperCase()}</button>`
  ).join('');
  document.getElementById('versionTabs').innerHTML = tabs +
    '<button class="tab tab-new" onclick="showNewVersionModal()">+ æ–°å»ºç‰ˆæœ¬</button>';
}

function renderVersionContent() {
  const container = document.getElementById('versionsContainer');
  container.innerHTML = '';

  Object.keys(versions).forEach(vKey => {
    const version = versions[vKey];
    const isActive = vKey === currentVersion;

    const sectionsHTML = version.sections.map((section, idx) => `
      <div class="section">
        <div class="section-header">
          <input type="text" class="section-title-input" value="${section.title}"
                 onchange="updateSectionTitle('${vKey}', ${idx}, this.value)">
          <button class="btn-remove-section" onclick="removeSection('${vKey}', ${idx})">åˆ é™¤</button>
        </div>
        <textarea onchange="updateSectionContent('${vKey}', ${idx}, this.value)"
                  oninput="enableAutoSave()">${section.content}</textarea>
      </div>
    `).join('');

    const versionHTML = `
      <div class="version-content ${isActive ? 'active' : ''}" data-version="${vKey}">
        <div class="version-header">
          <input type="text" class="version-title" value="${version.title}"
                 onchange="updateVersionTitle('${vKey}', this.value)">
          <button class="btn-delete" onclick="deleteVersion('${vKey}')">åˆ é™¤ç‰ˆæœ¬</button>
        </div>
        ${sectionsHTML}
        <button class="btn-add-section" onclick="addSection('${vKey}')">
          <span>â•</span> æ·»åŠ æ–°è§„åˆ™æ¿å—
        </button>
      </div>
    `;

    container.innerHTML += versionHTML;
  });
}

function switchVersion(vKey) {
  currentVersion = vKey;
  document.querySelectorAll('.version-content').forEach(el => el.classList.remove('active'));
  document.querySelector(`.version-content[data-version="${vKey}"]`).classList.add('active');
  renderTabs();
}

function showNewVersionModal() {
  document.getElementById('newVersionModal').classList.add('show');
  document.getElementById('newVersionInput').value = '';
  document.getElementById('newVersionInput').focus();
}

function closeModal(modalId) {
  document.getElementById(modalId).classList.remove('show');
}

function createVersion() {
  const input = document.getElementById('newVersionInput').value.trim().toLowerCase();
  if (!input) {
    alert('è¯·è¾“å…¥ç‰ˆæœ¬å·ï¼');
    return;
  }

  const vKey = input.startsWith('v') ? input : 'v' + input;

  if (versions[vKey]) {
    alert('è¯¥ç‰ˆæœ¬å·²å­˜åœ¨ï¼');
    return;
  }

  versions[vKey] = {
    title: vKey.toUpperCase() + ' ç»´ä¿®æ ‡å‡†ï¼ˆå†…éƒ¨é€šç”¨ï¼‰',
    sections: [{title: 'â‘  è§„åˆ™ä¸€', content: 'â€¢ åœ¨æ­¤è¾“å…¥è§„åˆ™å†…å®¹'}]
  };

  currentVersion = vKey;
  closeModal('newVersionModal');
  saveData();
  renderTabs();
  renderVersionContent();
  showSuccess('ç‰ˆæœ¬ ' + vKey.toUpperCase() + ' åˆ›å»ºæˆåŠŸï¼');
}

function deleteVersion(vKey) {
  if (Object.keys(versions).length === 1) {
    alert('è‡³å°‘éœ€è¦ä¿ç•™ä¸€ä¸ªç‰ˆæœ¬ï¼');
    return;
  }

  if (confirm(`ç¡®å®šè¦åˆ é™¤ ${vKey.toUpperCase()} ç‰ˆæœ¬å—ï¼Ÿ`)) {
    delete versions[vKey];
    currentVersion = Object.keys(versions)[0];
    saveData();
    renderTabs();
    renderVersionContent();
    showSuccess('ç‰ˆæœ¬å·²åˆ é™¤');
  }
}

function updateVersionTitle(vKey, newTitle) {
  versions[vKey].title = newTitle;
  enableAutoSave();
}

function updateSectionTitle(vKey, idx, newTitle) {
  versions[vKey].sections[idx].title = newTitle;
  enableAutoSave();
}

function updateSectionContent(vKey, idx, newContent) {
  versions[vKey].sections[idx].content = newContent;
  enableAutoSave();
}

function addSection(vKey) {
  const num = versions[vKey].sections.length + 1;
  const circledNum = String.fromCharCode(9311 + num); // â‘ â‘¡â‘¢â‘£...
  versions[vKey].sections.push({
    title: `${circledNum} è§„åˆ™${num}`,
    content: 'â€¢ åœ¨æ­¤è¾“å…¥è§„åˆ™å†…å®¹'
  });
  saveData();
  renderVersionContent();
}

function removeSection(vKey, idx) {
  if (versions[vKey].sections.length === 1) {
    alert('è‡³å°‘éœ€è¦ä¿ç•™ä¸€ä¸ªæ¿å—ï¼');
    return;
  }

  if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ¿å—å—ï¼Ÿ')) {
    versions[vKey].sections.splice(idx, 1);
    saveData();
    renderVersionContent();
  }
}

// ========== ç”Ÿæˆå’Œå¯¼å‡º ==========
function parseText(text) {
  return text.split('\n')
    .filter(line => line.trim())
    .map(line => {
      line = line.trim().replace(/^[â€¢Â·]\s*/, '');
      line = line.replace(/\s(ä½äº\s*\d+%|â‰¥\s*\d+%|OLED\s*å±|LCD\s*\+\s*IC|å…¨åŠŸèƒ½æ­£å¸¸|å…¨åŠŸèƒ½ä¿®å¥½)/g, ' <strong>$1</strong>');
      return `  <li>${line}</li>`;
    })
    .join('\n');
}

function generateHTMLContent() {
  const version = versions[currentVersion];
  const sectionsHTML = version.sections.map(section => `
<div class="card">
<h2>${section.title}</h2>
<ul>
${parseText(section.content)}
</ul>
</div>
`).join('\n');

  return `<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>${version.title.replace(/ï¼ˆ.*ï¼‰/, '')}ï¼ˆæ‘˜è¦ç‰ˆï¼‰</title>
<style>
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,'PingFang SC','Microsoft YaHei',sans-serif;
margin:0;padding:20px;line-height:1.55;background:#fafafa;color:#222;}
h1{font-size:22px;margin:0 0 16px 0;}
h2{font-size:18px;margin-top:20px;}
.card{background:#fff;border:1px solid #ddd;border-radius:8px;padding:16px;margin-bottom:16px;}
strong{color:#d60000;}
</style>
</head>
<body>
<h1>${version.title}</h1>
${sectionsHTML}
<footer style="margin-top:30px;font-size:12px;color:#666;">
ç¼–å·ï¼š${currentVersion.toUpperCase()} ï½œ ç”¨é€”ï¼šç»´ä¿®äº¤ä»˜æ ‡å‡†ï¼ˆå†…éƒ¨ï¼‰
</footer>
</body>
</html>`;
}

function generateHTML() {
  const html = generateHTMLContent();
  document.getElementById('htmlCode').textContent = html;
  document.getElementById('output').style.display = 'block';
  document.getElementById('output').scrollIntoView({behavior: 'smooth'});
}

function downloadHTML() {
  const code = generateHTMLContent();
  let filename = currentVersion.toLowerCase();
  if (!filename.endsWith('.html')) {
    filename = filename + '.html';
  }

  const blob = new Blob([code], {type: 'text/html; charset=utf-8'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  showSuccess('æ–‡ä»¶å·²ä¸‹è½½ï¼š' + filename);
}

// ========== æç¤ºä¿¡æ¯ ==========
function showSuccess(msg) {
  const el = document.getElementById('success');
  el.innerHTML = 'âœ… ' + msg;
  el.style.display = 'block';
  document.getElementById('warning').style.display = 'none';
  setTimeout(() => el.style.display = 'none', 8000);
}

function showWarning(msg) {
  const el = document.getElementById('warning');
  el.innerHTML = 'âš ï¸ ' + msg;
  el.style.display = 'block';
  document.getElementById('success').style.display = 'none';
  setTimeout(() => el.style.display = 'none', 8000);
}

// ========== åˆå§‹åŒ– ==========
checkAuth();
</script>
</body>
</html>